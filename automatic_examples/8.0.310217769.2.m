
K := Number Field with defining polynomial x^4 - 4*x^2 - x + 1 over the Rational Field
Q := 1/3831867375*(-81231110*K.1^3 + 7943740*K.1^2 + 252417240*K.1 + 134278672)*X^2 + 1/4157576101875*(-32709793060*K.1^3 + 7769232740*K.1^2 + 115459381740*K.1 + 87112480304)*X*Y + 1/4510970070534375*(-12964813259325*K.1^3 + 4167531899800*K.1^2 + 45610316540550*K.1 + 19904841831989)*X*Z + 1/9021940141068750*(-12964813259325*K.1^3 + 4167531899800*K.1^2 + 45610316540550*K.1 + 19904841831989)*Y^2 + 1/4894402526529796875*(-2025562675795140*K.1^3 + 856237346497160*K.1^2 + 8407482664464660*K.1 + 7495900165085524)*Y*Z + 1/10620853482569659218750*(-1207656605734159630*K.1^3 + 375946100821134570*K.1^2 + 4246914348569224695*K.1 + 1437120907343407159)*Z^2;
E := 1/4510970070534375*(-11325410850875*K.1^3 + 4600440690750*K.1^2 + 43891639020000*K.1 + 24473634378197)*X^3 + 1/9788805053059593750*(-19928548029637345*K.1^3 + 5421815793284680*K.1^2 + 74191183937045430*K.1 + 42979626367090137)*X^2*Y + 1/5310426741284829609375*(-2982490609150513920*K.1^3 + 534952705743019630*K.1^2 + 10749467370774815505*K.1 + 6152967101370806321)*X^2*Z + 1/5310426741284829609375*(-2982490609150513920*K.1^3 + 534952705743019630*K.1^2 + 10749467370774815505*K.1 + 6152967101370806321)*X*Y^2 + 1/5761813014294040126171875*(-1667778113398877821610*K.1^3 + 224036277792440898740*K.1^2 + 6012956734161715889865*K.1 + 3593249278367428234197)*X*Y*Z + 1/12503134241018067073792968750*(-501259494766542162837280*K.1^3 + 39195570865303146300495*K.1^2 + 1767098528494998703819495*K.1 + 1017009381352118086040427)*X*Z^2 + 1/11523626028588080252343750*(-518841865667769003870*K.1^3 + 127698046818281767705*K.1^2 + 1978812322057854432455*K.1 + 1197129545017246870149)*Y^3 + 1/6251567120509033536896484375*(-240258355424021328094265*K.1^3 + 47518141339511076144310*K.1^2 + 895241341483636371494435*K.1 + 498811114764869195958026)*Y^2*Z + 1/54263602606018411100261484375000*(-513205913614238452094402025*K.1^3 + 80205544977529587295689475*K.1^2 + 1937680669576857101137447100*K.1 + 1190453393229275160396513453)*Y*Z^2 + 1/474806522802661097127287988281250*(-399183300963331852478946365*K.1^3 + 116642316089920119348051435*K.1^2 + 1592035359944302187901147310*K.1 + 868739469238193805178323784)*Z^3 + T^3;

K := Number Field with defining polynomial x^4 - 4*x^2 - x + 1 over the Rational Field
Q := 1/3831867375*(-81231110*K.1^3 + 7943740*K.1^2 + 252417240*K.1 + 134278672)*X^2 + 1/4157576101875*(-32709793060*K.1^3 + 7769232740*K.1^2 + 115459381740*K.1 + 87112480304)*X*Y + 1/4510970070534375*(-12964813259325*K.1^3 + 4167531899800*K.1^2 + 45610316540550*K.1 + 19904841831989)*X*Z + 1/9021940141068750*(-12964813259325*K.1^3 + 4167531899800*K.1^2 + 45610316540550*K.1 + 19904841831989)*Y^2 + 1/4894402526529796875*(-2025562675795140*K.1^3 + 856237346497160*K.1^2 + 8407482664464660*K.1 + 7495900165085524)*Y*Z + 1/10620853482569659218750*(-1207656605734159630*K.1^3 + 375946100821134570*K.1^2 + 4246914348569224695*K.1 + 1437120907343407159)*Z^2;
E := 1/4510970070534375*(-11325410850875*K.1^3 + 4600440690750*K.1^2 + 43891639020000*K.1 + 24473634378197)*X^3 + 1/9788805053059593750*(-19928548029637345*K.1^3 + 5421815793284680*K.1^2 + 74191183937045430*K.1 + 42979626367090137)*X^2*Y + 1/5310426741284829609375*(-2982490609150513920*K.1^3 + 534952705743019630*K.1^2 + 10749467370774815505*K.1 + 6152967101370806321)*X^2*Z + 1/5310426741284829609375*(-2982490609150513920*K.1^3 + 534952705743019630*K.1^2 + 10749467370774815505*K.1 + 6152967101370806321)*X*Y^2 + 1/5761813014294040126171875*(-1667778113398877821610*K.1^3 + 224036277792440898740*K.1^2 + 6012956734161715889865*K.1 + 3593249278367428234197)*X*Y*Z + 1/12503134241018067073792968750*(-501259494766542162837280*K.1^3 + 39195570865303146300495*K.1^2 + 1767098528494998703819495*K.1 + 1017009381352118086040427)*X*Z^2 + 1/11523626028588080252343750*(-518841865667769003870*K.1^3 + 127698046818281767705*K.1^2 + 1978812322057854432455*K.1 + 1197129545017246870149)*Y^3 + 1/6251567120509033536896484375*(-240258355424021328094265*K.1^3 + 47518141339511076144310*K.1^2 + 895241341483636371494435*K.1 + 498811114764869195958026)*Y^2*Z + 1/54263602606018411100261484375000*(-513205913614238452094402025*K.1^3 + 80205544977529587295689475*K.1^2 + 1937680669576857101137447100*K.1 + 1190453393229275160396513453)*Y*Z^2 + 1/474806522802661097127287988281250*(-399183300963331852478946365*K.1^3 + 116642316089920119348051435*K.1^2 + 1592035359944302187901147310*K.1 + 868739469238193805178323784)*Z^3 + T^3;

K := Number Field with defining polynomial x^4 - 4*x^2 - x + 1 over the Rational Field

K := NumberFieldExtra(PolynomialRing(QQ)![1,-1,-4,0,1] : prec := 300); 
S<X,Y,Z,T> := PolynomialRing(K, 4);
Q := 1/128625*(575000*K.1^3 + 221900*K.1^2 - 2208810*K.1 - 1419318)*X^2 + 1/4501875*(-153115500*K.1^3 - 60826800*K.1^2 + 588431340*K.1 + 387024964)*X*Y + 1/157565625*(9159221750*K.1^3 + 3628138250*K.1^2 - 35197618575*K.1 - 23100730811)*X*Z + 1/315131250*(9159221750*K.1^3 + 3628138250*K.1^2 - 35197618575*K.1 - 23100730811)*Y^2 + 1/5514796875*(859371821500*K.1^3 + 340574405200*K.1^2 - 3302487234240*K.1 - 2168159942836)*Y*Z + 1/386035781250*(-42873025928375*K.1^3 - 16992558908450*K.1^2 + 164757508535595*K.1 + 108174078005139)*Z^2;
E := 1/157565625*(13058247000*K.1^3 + 5172827250*K.1^2 - 50181188625*K.1 - 32935574353)*X^3 + 1/11029593750*(1590636346250*K.1^3 + 630207030350*K.1^2 - 6112630599645*K.1 - 4012401111193)*X^2*Y + 1/64339296875*(830526951625*K.1^3 + 328717613650*K.1^2 - 3191541106215*K.1 - 2093665398753)*X^2*Z + 1/64339296875*(830526951625*K.1^3 + 328717613650*K.1^2 - 3191541106215*K.1 - 2093665398753)*X*Y^2 + 1/6755626171875*(-17827862551428875*K.1^3 - 7065902545205600*K.1^2 + 68510982690997815*K.1 + 44981533906551157)*X*Y*Z + 1/472893832031250*(-188877559323955375*K.1^3 - 74859896879675275*K.1^2 + 725840666494777545*K.1 + 476557844374624832)*X*Z^2 + 1/13511252343750*(-10227561207178375*K.1^3 - 4053586423233325*K.1^2 + 39303658442463855*K.1 + 25805154188013094)*Y^3 + 1/236446916015625*(1071473607310420750*K.1^3 + 424666091100292675*K.1^2 - 4117582772521909665*K.1 - 2703429618689275709)*Y^2*Z + 1/22068378828125000*(-23183327866866549000*K.1^3 - 9188452638183550125*K.1^2 + 89091578053401622950*K.1 + 58493777103891816551)*Y*Z^2 + 1/579294944238281250*(-4363276308376373695625*K.1^3 - 1729334545308948675800*K.1^2 + 16767703335710978781960*K.1 + 11008963299922388808644)*Z^3 + T^3;
C := Curve(Proj(S), [Q,E]);
//GeometricEndomorphismRepresentation(C);

CC := K`CC;
R<x,y,z> := PolynomialRing(K, 3);
F := Evaluate(Resultant(Q, E, 3), [x, y, 1, z]);
Y := Curve(ProjectiveSpace(R), [F]);
i := 3;
RS := RiemannSurface(DefiningPolynomial(AffinePatch(Y, i)), InfinitePlaces(K)[1] : Precision:=Precision(CC));
BPM := BigPeriodMatrix(RS);
g := #Rows(BPM);                                                                                                                                                                          
P1 := Submatrix(BPM, 1,1,   g,g);
P2 := Submatrix(BPM, 1,g+1, g,g);
P := ChangeRing(HorizontalJoin(P2, P1), K`CC);
GeometricEndomorphismRepresentation(P, NumberFieldExtra(PolynomialRing(QQ)![1,1,6,-4,15,-2,4,0,1]));

K := Number Field with defining polynomial x^4 - 4*x^2 - x + 1 over the Rational Field
Q := 1/3831867375*(-81231110*K.1^3 + 7943740*K.1^2 + 252417240*K.1 + 134278672)*X^2 + 1/4157576101875*(-32709793060*K.1^3 + 7769232740*K.1^2 + 115459381740*K.1 + 87112480304)*X*Y + 1/4510970070534375*(-12964813259325*K.1^3 + 4167531899800*K.1^2 + 45610316540550*K.1 + 19904841831989)*X*Z + 1/9021940141068750*(-12964813259325*K.1^3 + 4167531899800*K.1^2 + 45610316540550*K.1 + 19904841831989)*Y^2 + 1/4894402526529796875*(-2025562675795140*K.1^3 + 856237346497160*K.1^2 + 8407482664464660*K.1 + 7495900165085524)*Y*Z + 1/10620853482569659218750*(-1207656605734159630*K.1^3 + 375946100821134570*K.1^2 + 4246914348569224695*K.1 + 1437120907343407159)*Z^2;
E := 1/4510970070534375*(-11325410850875*K.1^3 + 4600440690750*K.1^2 + 43891639020000*K.1 + 24473634378197)*X^3 + 1/9788805053059593750*(-19928548029637345*K.1^3 + 5421815793284680*K.1^2 + 74191183937045430*K.1 + 42979626367090137)*X^2*Y + 1/5310426741284829609375*(-2982490609150513920*K.1^3 + 534952705743019630*K.1^2 + 10749467370774815505*K.1 + 6152967101370806321)*X^2*Z + 1/5310426741284829609375*(-2982490609150513920*K.1^3 + 534952705743019630*K.1^2 + 10749467370774815505*K.1 + 6152967101370806321)*X*Y^2 + 1/5761813014294040126171875*(-1667778113398877821610*K.1^3 + 224036277792440898740*K.1^2 + 6012956734161715889865*K.1 + 3593249278367428234197)*X*Y*Z + 1/12503134241018067073792968750*(-501259494766542162837280*K.1^3 + 39195570865303146300495*K.1^2 + 1767098528494998703819495*K.1 + 1017009381352118086040427)*X*Z^2 + 1/11523626028588080252343750*(-518841865667769003870*K.1^3 + 127698046818281767705*K.1^2 + 1978812322057854432455*K.1 + 1197129545017246870149)*Y^3 + 1/6251567120509033536896484375*(-240258355424021328094265*K.1^3 + 47518141339511076144310*K.1^2 + 895241341483636371494435*K.1 + 498811114764869195958026)*Y^2*Z + 1/54263602606018411100261484375000*(-513205913614238452094402025*K.1^3 + 80205544977529587295689475*K.1^2 + 1937680669576857101137447100*K.1 + 1190453393229275160396513453)*Y*Z^2 + 1/474806522802661097127287988281250*(-399183300963331852478946365*K.1^3 + 116642316089920119348051435*K.1^2 + 1592035359944302187901147310*K.1 + 868739469238193805178323784)*Z^3 + T^3;




K := NumberFieldExtra(PolynomialRing(QQ)![1,-1,-4,0,1] : prec := 300); 
OK := RingOfIntegers(K);
S<X,Y,Z,T> := PolynomialRing(K, 4);
Q := 1/128625*(575000*K.1^3 + 221900*K.1^2 - 2208810*K.1 - 1419318)*X^2 + 1/4501875*(-153115500*K.1^3 - 60826800*K.1^2 + 588431340*K.1 + 387024964)*X*Y + 1/157565625*(9159221750*K.1^3 + 3628138250*K.1^2 - 35197618575*K.1 - 23100730811)*X*Z + 1/315131250*(9159221750*K.1^3 + 3628138250*K.1^2 - 35197618575*K.1 - 23100730811)*Y^2 + 1/5514796875*(859371821500*K.1^3 + 340574405200*K.1^2 - 3302487234240*K.1 - 2168159942836)*Y*Z + 1/386035781250*(-42873025928375*K.1^3 - 16992558908450*K.1^2 + 164757508535595*K.1 + 108174078005139)*Z^2;
E := 1/157565625*(13058247000*K.1^3 + 5172827250*K.1^2 - 50181188625*K.1 - 32935574353)*X^3 + 1/11029593750*(1590636346250*K.1^3 + 630207030350*K.1^2 - 6112630599645*K.1 - 4012401111193)*X^2*Y + 1/64339296875*(830526951625*K.1^3 + 328717613650*K.1^2 - 3191541106215*K.1 - 2093665398753)*X^2*Z + 1/64339296875*(830526951625*K.1^3 + 328717613650*K.1^2 - 3191541106215*K.1 - 2093665398753)*X*Y^2 + 1/6755626171875*(-17827862551428875*K.1^3 - 7065902545205600*K.1^2 + 68510982690997815*K.1 + 44981533906551157)*X*Y*Z + 1/472893832031250*(-188877559323955375*K.1^3 - 74859896879675275*K.1^2 + 725840666494777545*K.1 + 476557844374624832)*X*Z^2 + 1/13511252343750*(-10227561207178375*K.1^3 - 4053586423233325*K.1^2 + 39303658442463855*K.1 + 25805154188013094)*Y^3 + 1/236446916015625*(1071473607310420750*K.1^3 + 424666091100292675*K.1^2 - 4117582772521909665*K.1 - 2703429618689275709)*Y^2*Z + 1/22068378828125000*(-23183327866866549000*K.1^3 - 9188452638183550125*K.1^2 + 89091578053401622950*K.1 + 58493777103891816551)*Y*Z^2 + 1/579294944238281250*(-4363276308376373695625*K.1^3 - 1729334545308948675800*K.1^2 + 16767703335710978781960*K.1 + 11008963299922388808644)*Z^3 + T^3;


Q1 := DiagonalForm(Q);
//coef := &cat[Flat(c) : c in Coefficients(Q1)];
Q1 *:= LCM([Denominator(c) : c in Coefficients(Q1)]);
//coef := &cat[Flat(c) : c in Coefficients(Q1)];

D := &*Coefficients(Q1);
Dec := Decomposition(OK!D);

Fp, m := quo<OK | Dec[1][1]>;//^(Dec[1][2])>;
Fp, m := ResidueClassField(OK, Dec[1][1]^(Dec[1][2]));
S<X,Y,Z> := PolynomialRing(OK, 3);
Fpx<x,y,z> := PolynomialRing(Fp, 3);
inc := hom<Fp -> Fpx | >;
h := hom<S -> Fpx | m*inc,[x, y, z]>;
Q1 := Evaluate(Q1, [X, Y, Z]);
Factorization(h(S!Q1));

_, p := IsPrincipal(Dec[1][1]);
Q2 := Evaluate(Q1, [Y, p*X, Z]);
Min([Valuation(c, Dec[1][1]) : c in Coefficients(Q2)]);
Q2 div p;
// do it mod p, then pick representative mod p^2...
// ModDed ?

OK! mod (Dec[1][1]^(Dec[1][2]));

ideal<OK | Dec[1][1], Dec[1][2]>;
for l in Dec do
    
end for;

for i in [1..#Dec] do
    Fp := FiniteField(#);
    IsField(quo<OK | Dec[i][1]^(Dec[i][2])>);
end for;